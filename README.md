# Jinja 2 template to generate DIY Hooks yaml file for Marussia assistant

Есть маркетинговый продукт [Маруся - голосовой помощник](https://marusia.mail.ru/). Из опыта общения с продуктом сложилось впечатление, что развиваться в нем будет только то, что приносит подписку ВК.

Интеграция с умными устройствами выполнена, но видимо одной библиотекой, т.к. поддерживаются шаблонные OEM-оболочки.

Поддержка Home Assistant запрашивалась очень давно многими людьми, но о планах её добавить мне не известно, в том числе поддержка на мои вопросы положительно не ответила.

В это же время, HASS гораздо более функционален, чем любое существующее решение, с которым Маруся умеет интегрироваться. И отказываться от него в сторону продукта с вендор-локом на конкретного производителя нет ни какого желания.

К счастью, в секции "Умный дом" в Марусе есть интегарция `DIY Hooks`, с которыми можно интегрировать [Home Assistant REST API](https://developers.home-assistant.io/docs/api/rest/).

Интеграция принимает yaml-форматированный манифест с описанием устройств.

## Что поддерживается и что планируется добавить

- [x] light - можно включить, выключить, Маруся может узнать текущий статус устройства. Управление уровнем яркости невозможно из-за ограничений `DIY Hooks`.
- [ ] switch
- [ ] media_player
- [ ] fan


## Как подружить Марусю с вашим Home Assistant:
1. Веб-интерфейс вашего инстанса должен быть доступен из Интернет.
2. Нужно создать [Long-lived access token
](https://developers.home-assistant.io/docs/auth_api/#long-lived-access-token).
3. Копируем текст шалона [marussia-diy-hooks.yaml.j2](marussia-diy-hooks.yaml.j2) в буфер обмена.
4. Переходим в Home Assistant на страницу `Developer Tools` -> `Templates`.
5. Вставляем текст шаблона.
6. В переменной `hass_url` указываем URL вашего инстанса HASS, например `https://my-lovely-home.net`.
7. В переменной `hass_token` указываем токен из шага `2`.
8. Справа появляется готовый yaml-текст для интеграции с Марусей.
9. Переходим на страницу [DIY Hooks](https://vc.go.mail.ru.j2/smarthouse/diy/)
10. Авторизовываемся тем же VKID, под которым работает Маруся.
11. Вставляем текст из шага `8` и нажимаем `Сохранить`.
12. В приложении `Маруся` на телефоне идем в `Настройки` -> `Умный дом`. Выбираем `DIY Hooks`.
13. Должны попасть на страницу из шага 9, на которой уже загружен ваш конфиг. Нажимаем `Выбрать`. Если конфига нет, можно текст из шага `8` вставить сейчас.
14. Теперь в секции `Умный дом` будут отображаться устройства из HASS. Ими можно попробовтаь управлять из этой же странички, плюс появятся подсказки чт осказать Марусе, чтобы управлять устройствами голосом.

_Такой вот 'простой' и 'дружелюбный' продукт._

## Команде проекта Маруси

Возможно текст вас в чем то обижает. И продакт дает другие задачи, а вам бы хотелось сделать все лучше. Понимаю, принимаю.

Обижает только пользовательский опыт:
- Можно HASS? - _нет и не планируем._
- Я выключил все уведомления в настройках маруси, но она всеравно присылает сам. - _смиритесь._
- Маруся триггерится на свое имя в рекламе про Марусю. - _Знаем, однажды поправим._
- Пассивно-агрессивный текст в приложении Маруся _"Когда **я захочу** вам что-то рассказать, на телефон придет пуш, а колонка будет светиться..."_ - Маруся, ты исполнитель/ассистент. **Я хочу, ты помогаешь**. Не наоборот. Ненадо мне внезапно включать подсветку на капсуле-мини потому что ты решила что-то сказать.

В это же время напомнить про продление подписки Маруся не забудет. Ощущение, что выложив достаточно большую сумму денег за колонку, я должен еще, иначе я не нужен.
